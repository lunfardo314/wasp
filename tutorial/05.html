<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Structure of the smart contract - ISCP Documentation</title>
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../welcome.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li class="chapter-item expanded "><a href="../tutorial/index.html"><strong aria-hidden="true">2.</strong> Tutorials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tutorial/01.html"><strong aria-hidden="true">2.1.</strong> The Solo package</a></li><li class="chapter-item expanded "><a href="../tutorial/02.html"><strong aria-hidden="true">2.2.</strong> Tokens and the UTXO Ledger</a></li><li class="chapter-item expanded "><a href="../tutorial/03.html"><strong aria-hidden="true">2.3.</strong> Creating a chain; Core contracts</a></li><li class="chapter-item expanded "><a href="../tutorial/04.html"><strong aria-hidden="true">2.4.</strong> Deploying and running a Rust smart contract</a></li><li class="chapter-item expanded "><a href="../tutorial/05.html" class="active"><strong aria-hidden="true">2.5.</strong> Structure of the smart contract</a></li><li class="chapter-item expanded "><a href="../tutorial/06.html"><strong aria-hidden="true">2.6.</strong> Invoking smart contracts. Sending a request</a></li><li class="chapter-item expanded "><a href="../tutorial/07.html"><strong aria-hidden="true">2.7.</strong> Invoking smart contracts. Calling a view</a></li><li class="chapter-item expanded "><a href="../tutorial/08.html"><strong aria-hidden="true">2.8.</strong> Accounts: deposit and withdraw tokens</a></li><li class="chapter-item expanded "><a href="../tutorial/09.html"><strong aria-hidden="true">2.9.</strong> Sending tokens to the smart contract</a></li><li class="chapter-item expanded "><a href="../tutorial/10.html"><strong aria-hidden="true">2.10.</strong> Return of tokens in case of failure</a></li><li class="chapter-item expanded "><a href="../tutorial/11.html"><strong aria-hidden="true">2.11.</strong> Sending tokens from smart contract to address</a></li></ol></li><li class="chapter-item expanded "><a href="../setup_wasp.html"><strong aria-hidden="true">3.</strong> Setup a private ISCP Cluster</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">ISCP Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                            </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="exploring-iota-smart-contracts"><a class="header" href="#exploring-iota-smart-contracts">Exploring IOTA Smart Contracts</a></h1>
<p>Previous: <a href="04.html">Deploying and running a Rust smart contract</a></p>
<h2 id="structure-of-the-smart-contract"><a class="header" href="#structure-of-the-smart-contract">Structure of the smart contract</a></h2>
<p>Smart contracts are programs, immutably stored in the chain. In the previous
example the binary file with the code of the smart contract
<em>example_tutorial_bg.wasm</em> will be immutably stored in the chain state.</p>
<p>The logical structure of an ISCP smart contract is independent of the VM type we
use, be it a <em>Wasm</em> smart contract or any other VM type.</p>
<p><img src="SC-structure.png" alt="" /></p>
<p>Each smart contract on the chain is identified by its name hashed into 4 bytes
and interpreted as <code>uint32</code> value: the so called <code>hname</code>. For example,
the <code>hname</code> of the root contract is <em>0xcebf5908</em>, the unique identifier of the
<code>root</code> contract in every chain.</p>
<p>Each smart contract instance has a program with a collection of entry points and
a state. An entry point is a function of the program through which the program
can be invoked. The <code>example1</code> contract above has three entry
points: <code>storeString</code>, <code>getString</code> and <code>withdrawIota</code>.</p>
<p>There are several ways to invoke an entry point: a request, a call and a view
call, depending on the type of the entry point.</p>
<p>The smart contract program can access its state and account through an interface
layer called the <em>Sandbox</em>.</p>
<h3 id="state"><a class="header" href="#state">State</a></h3>
<p>The smart contract state is its data, with each update stored on the chain. The
state can only be modified by the smart contract program itself. There are two
parts of the state:</p>
<ul>
<li>A collection of key/value pairs called the <code>data state</code>. Each key and value
are byte arrays of arbitrary size (there are practical limits set by the
database, of course). The value of the key/value pair is always retrieved by
its key.</li>
<li>A collection of <code>color: balance</code> pairs called the <code>account</code>. The account
represents the balances of tokens of specific colors controlled by the smart
contract. Receiving and spending tokens into/from the account means changing
the account's balances.</li>
</ul>
<p>Only the smart contract program can change its data state and spend from its
account. Tokens can be sent to the smart contract account by any other agent on
the ledger, be it a wallet with an address or another smart contract.</p>
<p>See <a href="accounts.html">Accounts</a> for more info on sending and receiving tokens.</p>
<h3 id="entry-points"><a class="header" href="#entry-points">Entry points</a></h3>
<p>There are two types of entry points:</p>
<ul>
<li><em>Full entry points</em> or just <em>entry points</em>. These functions can modify
(mutate) the state of the smart contract.</li>
<li><em>View entry points</em> or <em>views</em>. These are read-only functions. They are used
only to retrieve the information from the smart contract state. They can’t
modify the state, i.e. are read-only calls.</li>
</ul>
<p>The <code>example1</code> program has three entry points:</p>
<ul>
<li>
<p><code>storeString</code> a full entry point. It first checks if parameter
called <code>paramString</code> exist. If so, it stores the string value of the parameter
into the state variable <code>storedString</code>. If parameter <code>paramString</code> is missing,
the program panics.</p>
</li>
<li>
<p><code>getString</code> is a view entry point that returns the value of the
variable <code>storedString</code>.</p>
</li>
<li>
<p><code>withdrawIota</code> is a full entry point that checks if the caller is and address
and if the caller is equal to the creator of smart contract. If not, it
panics. If it passes the validation, the program sends all the iotas contained
in the smart contract's account to the caller.</p>
</li>
</ul>
<p>Note that in <code>example1</code> the Rust functions associated with full entry points
take a parameter of type <code>ScFuncContext</code>. It gives full (read-write) access to
the state. In contrast, <code>getString</code> is a view entry point and its associated
function parameter has type <code>ScViewContext</code>. A view is not allowed to mutate 
the state.</p>
<h2 id="panic-exception-handling"><a class="header" href="#panic-exception-handling">Panic. Exception handling</a></h2>
<p>The following test posts a request to the <code>example1</code> smart contract without 
the expected parameter <code>paramString</code>. The
statement <code>ctx.require(par.exists(), &quot;string parameter not found&quot;);</code> makes 
the smart contract panic if the condition is not satisfied.</p>
<pre><code class="language-go">func TestTutorial4(t *testing.T) {
    env := solo.New(t, false, false)
    chain := env.NewChain(nil, &quot;ex4&quot;)
    // deploy the contract on chain
    err := chain.DeployWasmContract(nil, &quot;example1&quot;, &quot;example_tutorial_bg.wasm&quot;)
    require.NoError(t, err)
    
    // call contract incorrectly (omit 'paramString')
    req := solo.NewCallParams(&quot;example1&quot;, &quot;storeString&quot;)
    req.WithIotas(1)
    _, err = chain.PostRequestSync(req, nil)
    require.Error(t, err)
}
</code></pre>
<p>The fragment in the output of the test:</p>
<pre><code>39:25.991	PANIC	TestTutorial4.ex4	vmcontext/log.go:12	string parameter not found
39:25.993	INFO	TestTutorial4.ex4	vmcontext/runreq.go:311	eventlog -&gt; '[req] [0]5yBro4RpemZvCjJr4U6RLjcXdXdtnV3b3WjM9HUWZE8v: [0]5yBro4RpemZvCjJr4U6RLjcXdXdtnV3b3WjM9HUWZE8v: recovered from panic in VM: string parameter not found'
</code></pre>
<p>It shows that the panic indeed occurred. The test passes because the resulting
error was expected.</p>
<p>Note that this test ends with the state <code>#4</code>, despite the fact that the last
request to the smart contract failed. This is important: <strong>whatever happens
during the execution of a smart contract's full entry point, processing of the 
request always results in the state transition</strong>.</p>
<p>The VM context catches exceptions (panics) in the program. Its consequences are
recorded in the state of the chain during the fallback processing, no matter if
the panic was triggered by the logic of the smart contract or whether it was 
triggered by the sandbox run-time code.</p>
<p>In the case of <code>example1</code> the error event was recorded in the immutable event
log of the chain, but the data state of the smart contract wasn't modified. In
other cases the fallback actions may be more complex.</p>
<p>Next: <a href="06.html">Invoking smart contracts. Sending a request</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../tutorial/04.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../tutorial/06.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../tutorial/04.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../tutorial/06.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
                
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
